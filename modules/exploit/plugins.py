"""
SROF · Exploit Plugins
Wrappers for exploitation frameworks: Metasploit, sqlmap, etc.
"""
import subprocess, shutil, json, tempfile, os
from typing import Generator
from core.plugin import SROFPlugin, PluginConfig, Finding, register, PluginCategory, Severity


def _which(cmd): return shutil.which(cmd) is not None


def _run(cmd, timeout=120):
    try:
        r = subprocess.run(cmd, capture_output=True, text=True, timeout=timeout)
        return r.returncode, r.stdout, r.stderr
    except subprocess.TimeoutExpired:
        return -1, "", "timeout"
    except FileNotFoundError:
        return -2, "", f"not found: {cmd[0]}"
    except Exception as e:
        return -3, "", str(e)


# ─── SQLMAP ──────────────────────────────────────────────────────────────────
@register
class SqlmapPlugin(SROFPlugin):
    id          = "exploit.sqlmap"
    name        = "sqlmap"
    category    = PluginCategory.EXPLOIT
    description = "Automatic SQL injection detection and exploitation"
    tags        = ["sqli", "database", "injection"]
    author      = "XiaoYao @ Alfanet"

    def run(self, config: PluginConfig) -> Generator[Finding, None, None]:
        if not _which("sqlmap"):
            self.warn("sqlmap not installed. Install: pip install sqlmap")
            return

        target = config.target
        self.info(f"sqlmap scanning {target}")

        with tempfile.TemporaryDirectory() as tmpdir:
            cmd = [
                "sqlmap", "-u", target,
                "--batch", "--level=2", "--risk=1",
                "--output-dir", tmpdir,
                "--forms", "--crawl=2",
                "--timeout", str(config.timeout),
            ]
            if config.proxy:
                cmd += ["--proxy", config.proxy]

            rc, out, err = _run(cmd, timeout=600)
            if rc == -2:
                self.warn("sqlmap not found")
                return

        for line in out.splitlines():
            if "injectable" in line.lower() or "parameter" in line.lower():
                yield Finding(
                    type="vuln",
                    value=target,
                    severity=Severity.CRITICAL,
                    title=f"SQL Injection: {line.strip()[:100]}",
                    description=line.strip(),
                    source=self.id,
                    metadata={"tool": "sqlmap"},
                )

        self.info("sqlmap scan complete")


# ─── METASPLOIT RPC ──────────────────────────────────────────────────────────
@register
class MetasploitPlugin(SROFPlugin):
    id          = "exploit.msf_rpc"
    name        = "Metasploit RPC"
    category    = PluginCategory.EXPLOIT
    description = "Run Metasploit modules via msfconsole (resource script)"
    tags        = ["msf", "rce", "exploit", "c2"]
    author      = "XiaoYao @ Alfanet"

    def run(self, config: PluginConfig) -> Generator[Finding, None, None]:
        if not _which("msfconsole"):
            self.warn("Metasploit not installed. See: https://metasploit.com")
            return

        module  = config.get("module", "")
        options = config.get("options", {})
        if not module:
            self.warn("No module specified in config.extra['module']")
            return

        self.info(f"Running MSF module: {module} against {config.target}")

        rc_lines = [f"use {module}"]
        rc_lines.append(f"set RHOSTS {config.target}")
        for k, v in options.items():
            rc_lines.append(f"set {k} {v}")
        rc_lines += ["run", "exit"]

        with tempfile.NamedTemporaryFile(suffix=".rc", delete=False, mode="w") as f:
            f.write("\n".join(rc_lines))
            rc_file = f.name

        cmd = ["msfconsole", "-q", "-r", rc_file]
        rc, out, err = _run(cmd, timeout=300)
        os.unlink(rc_file)

        if rc == -2:
            self.warn("msfconsole not found")
            return

        for line in out.splitlines():
            if any(k in line.lower() for k in ["session", "shell", "meterpreter", "opened"]):
                yield Finding(
                    type="vuln",
                    value=config.target,
                    severity=Severity.CRITICAL,
                    title=f"MSF Session: {line.strip()[:100]}",
                    description=line.strip(),
                    source=self.id,
                    metadata={"tool": "metasploit", "module": module},
                )

        self.info("Metasploit run complete")
